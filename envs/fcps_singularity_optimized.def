Bootstrap: docker
From: rocker/tidyverse:4.3.3

%labels

    AUTHOR izaskun.mallona@gmail.com
    AUTHOR ben.uzh@proton.me

%post

    # Install python3.12
    apt-get update
    apt install -y build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev \
        libreadline-dev libffi-dev libsqlite3-dev wget libbz2-dev python-is-python3 git \
        libgsl-dev

    wget https://www.python.org/ftp/python/3.12.9/Python-3.12.9.tgz
    tar -xf Python-3.12.9.tgz
    cd Python-3.12.*/
    ./configure --enable-optimizations
    make -j 8
    make altinstall

    # virtualenv
    cd /opt
    python3.12 -m venv "default"
    . default/bin/activate

    # TODO: pin dependencies
    pip install gitpython==3.1.43 isodate pydantic-core

    ## no versioning here
    ## TODO(ben): get same versions as in easyconfig
    Rscript -e 'BiocManager::install(c( "dbscan", "cluster", "protoclust", "energy", "argparse", "mclust", "DataVisualizations", "FCPS", "cclust"))'

    echo '. /opt/default/bin/activate' >> $SINGULARITY_ENVIRONMENT

%environment

    . /opt/default/bin/activate
